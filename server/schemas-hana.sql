-- ============================================
-- HANA DB 스키마 파일
-- ============================================
-- 이 파일은 SAP HANA 데이터베이스용 스키마입니다.
-- PostgreSQL을 사용하는 경우 schemas-postgres.sql을 참조하세요.
-- ============================================

-- 스키마 생성 (필요한 경우)
-- CREATE SCHEMA EAR;

-- 채팅 히스토리 테이블
CREATE TABLE EAR.chat_history (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    SESSION_ID NVARCHAR(100) NOT NULL,
    USER_ID NVARCHAR(100),
    USER_MESSAGE NCLOB NOT NULL,
    ASSISTANT_RESPONSE NCLOB NOT NULL,
    SOURCES NCLOB,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스 생성
CREATE INDEX idx_chat_session_id ON EAR.chat_history(SESSION_ID);
CREATE INDEX idx_chat_user_id ON EAR.chat_history(USER_ID);
CREATE INDEX idx_chat_created_at ON EAR.chat_history(CREATED_AT);

-- RAG 문서관리 테이블
CREATE TABLE EAR.rag_documents (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    NAME NVARCHAR(500) NOT NULL,
    FILE_PATH NVARCHAR(1000),
    FILE_TYPE NVARCHAR(100),
    FILE_SIZE BIGINT,
    TEXT_CONTENT NCLOB,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE EAR.rag_chunks (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    DOCUMENT_ID INTEGER,
    CHUNK_INDEX INTEGER NOT NULL,
    CONTENT NCLOB NOT NULL,
    EMBEDDING NCLOB,
    PAGE_NUMBER INTEGER,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (DOCUMENT_ID) REFERENCES EAR.rag_documents(ID) ON DELETE CASCADE
);

-- RAG 테이블 인덱스
CREATE INDEX idx_rag_documents_name ON EAR.rag_documents(NAME);
CREATE INDEX idx_rag_documents_created_at ON EAR.rag_documents(CREATED_AT);
CREATE INDEX idx_rag_chunks_document_id ON EAR.rag_chunks(DOCUMENT_ID);

-- EAR 요청등록 관련 테이블
CREATE TABLE EAR.ear_keywords (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    KEYWORD NVARCHAR(100) NOT NULL UNIQUE,
    DISPLAY_NAME NVARCHAR(200) NOT NULL,
    CATEGORY NVARCHAR(100),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE EAR.ear_request_templates (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    KEYWORD_ID INTEGER,
    TEMPLATE_NAME NVARCHAR(200) NOT NULL,
    TEMPLATE_DESCRIPTION NCLOB,
    REQUIRED_FIELDS NCLOB,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (KEYWORD_ID) REFERENCES EAR.ear_keywords(ID) ON DELETE CASCADE,
    UNIQUE(KEYWORD_ID, TEMPLATE_NAME)
);

CREATE TABLE EAR.ear_requests (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    REQUEST_TITLE NVARCHAR(500) NOT NULL,
    REQUEST_CONTENT NCLOB NOT NULL,
    TEMPLATE_ID INTEGER,
    FORM_DATA NCLOB,
    ATTACHMENTS NCLOB,
    STATUS NVARCHAR(50) DEFAULT 'pending',
    CREATED_BY NVARCHAR(100),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (TEMPLATE_ID) REFERENCES EAR.ear_request_templates(ID)
);

-- EAR 테이블 인덱스
CREATE INDEX idx_ear_keywords_keyword ON EAR.ear_keywords(KEYWORD);
CREATE INDEX idx_ear_keywords_category ON EAR.ear_keywords(CATEGORY);
CREATE INDEX idx_ear_request_templates_keyword_id ON EAR.ear_request_templates(KEYWORD_ID);
CREATE INDEX idx_ear_requests_status ON EAR.ear_requests(STATUS);
CREATE INDEX idx_ear_requests_created_at ON EAR.ear_requests(CREATED_AT);

-- 개선요청 관련 테이블
CREATE TABLE EAR.improvement_requests (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    SESSION_ID NVARCHAR(100) NOT NULL,
    CHAT_HISTORY_ID INTEGER,
    SELECTED_TEXT NCLOB NOT NULL,
    CATEGORY NVARCHAR(50) NOT NULL,
    DESCRIPTION NCLOB NOT NULL,
    STATUS NVARCHAR(50) DEFAULT 'pending',
    CREATED_BY NVARCHAR(100),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (CHAT_HISTORY_ID) REFERENCES EAR.chat_history(ID) ON DELETE CASCADE
);

CREATE TABLE EAR.improvement_responses (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    REQUEST_ID INTEGER,
    RESPONSE_TEXT NCLOB NOT NULL,
    RESPONDED_BY NVARCHAR(100),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (REQUEST_ID) REFERENCES EAR.improvement_requests(ID) ON DELETE CASCADE
);

-- 개선요청 테이블 인덱스
CREATE INDEX idx_improvement_requests_session_id ON EAR.improvement_requests(SESSION_ID);
CREATE INDEX idx_improvement_requests_chat_history_id ON EAR.improvement_requests(CHAT_HISTORY_ID);
CREATE INDEX idx_improvement_requests_category ON EAR.improvement_requests(CATEGORY);
CREATE INDEX idx_improvement_requests_status ON EAR.improvement_requests(STATUS);
CREATE INDEX idx_improvement_requests_created_at ON EAR.improvement_requests(CREATED_AT);
CREATE INDEX idx_improvement_responses_request_id ON EAR.improvement_responses(REQUEST_ID);

-- 사용자 관리 테이블
CREATE TABLE EAR.users (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    USERID NVARCHAR(100) NOT NULL UNIQUE,
    PASSWORD_HASH NVARCHAR(255) NOT NULL,
    EMAIL NVARCHAR(255),
    FULL_NAME NVARCHAR(200),
    DEPARTMENT NVARCHAR(100),
    POSITION NVARCHAR(100),
    PHONE NVARCHAR(50),
    EMPLOYEE_ID NVARCHAR(50),
    IS_ACTIVE BOOLEAN DEFAULT true,
    IS_ADMIN BOOLEAN DEFAULT false,
    FAILED_LOGIN_ATTEMPTS INTEGER DEFAULT 0,
    LOCKED_UNTIL TIMESTAMP NULL,
    LAST_LOGIN TIMESTAMP NULL,
    PASSWORD_RESET_TOKEN NVARCHAR(255) NULL,
    PASSWORD_RESET_EXPIRES TIMESTAMP NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 로그인 이력 테이블
CREATE TABLE EAR.login_history (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    USER_ID INTEGER,
    USERID NVARCHAR(100) NOT NULL,
    LOGIN_TIME TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    IP_ADDRESS NVARCHAR(45),
    USER_AGENT NCLOB,
    LOGIN_STATUS NVARCHAR(20) NOT NULL,
    FAILURE_REASON NVARCHAR(100) NULL,
    FOREIGN KEY (USER_ID) REFERENCES EAR.users(ID) ON DELETE CASCADE
);

-- 사용자 테이블 인덱스
CREATE INDEX idx_users_userid ON EAR.users(USERID);
CREATE INDEX idx_users_email ON EAR.users(EMAIL);
CREATE INDEX idx_users_employee_id ON EAR.users(EMPLOYEE_ID);
CREATE INDEX idx_users_is_active ON EAR.users(IS_ACTIVE);
CREATE INDEX idx_users_is_admin ON EAR.users(IS_ADMIN);
CREATE INDEX idx_users_locked_until ON EAR.users(LOCKED_UNTIL);

-- 로그인 이력 테이블 인덱스
CREATE INDEX idx_login_history_user_id ON EAR.login_history(USER_ID);
CREATE INDEX idx_login_history_userid ON EAR.login_history(USERID);
CREATE INDEX idx_login_history_login_time ON EAR.login_history(LOGIN_TIME);
CREATE INDEX idx_login_history_login_status ON EAR.login_history(LOGIN_STATUS);

-- 인터페이스 자동화 관련 테이블
CREATE TABLE EAR.company_interfaces (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    COMPANY_NAME NVARCHAR(200) NOT NULL,
    API_URL NCLOB NOT NULL,
    AUTH_TYPE NVARCHAR(50) NOT NULL DEFAULT 'none',
    AUTH_CONFIG NCLOB,
    API_FIELDS NCLOB,
    FIELD_MAPPINGS NCLOB,
    STATUS NVARCHAR(50) DEFAULT 'active',
    CREATED_BY NVARCHAR(100),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE EAR.interface_history (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    INTERFACE_ID INTEGER,
    CHANGE_TYPE NVARCHAR(50) NOT NULL,
    CHANGES NCLOB,
    PREVIOUS_STATE NCLOB,
    CHANGED_BY NVARCHAR(100),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (INTERFACE_ID) REFERENCES EAR.company_interfaces(ID) ON DELETE CASCADE
);

CREATE TABLE EAR.standard_batch_services (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    SERVICE_NAME NVARCHAR(200) NOT NULL,
    COMPANY_NAME NVARCHAR(200) NOT NULL,
    SERVICE_CONFIG NCLOB,
    GENERATED_CODE NCLOB,
    STATUS NVARCHAR(50) DEFAULT 'active',
    CREATED_BY NVARCHAR(100),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인터페이스 자동화 테이블 인덱스
CREATE INDEX idx_company_interfaces_company_name ON EAR.company_interfaces(COMPANY_NAME);
CREATE INDEX idx_company_interfaces_status ON EAR.company_interfaces(STATUS);
CREATE INDEX idx_company_interfaces_created_at ON EAR.company_interfaces(CREATED_AT);
CREATE INDEX idx_interface_history_interface_id ON EAR.interface_history(INTERFACE_ID);
CREATE INDEX idx_interface_history_change_type ON EAR.interface_history(CHANGE_TYPE);
CREATE INDEX idx_interface_history_created_at ON EAR.interface_history(CREATED_AT);
CREATE INDEX idx_standard_batch_services_company_name ON EAR.standard_batch_services(COMPANY_NAME);
CREATE INDEX idx_standard_batch_services_status ON EAR.standard_batch_services(STATUS);

-- 시스템 개선요청 테이블
CREATE TABLE EAR.system_improvement_requests (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    TITLE NVARCHAR(500) NOT NULL,
    CONTENT NCLOB NOT NULL,
    ATTACHMENTS NCLOB,
    STATUS NVARCHAR(50) DEFAULT 'pending',
    CREATED_BY NVARCHAR(100),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE EAR.system_improvement_responses (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    REQUEST_ID INTEGER,
    RESPONSE_TEXT NCLOB NOT NULL,
    RESPONDED_BY NVARCHAR(100),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (REQUEST_ID) REFERENCES EAR.system_improvement_requests(ID) ON DELETE CASCADE
);

-- 시스템 개선요청 테이블 인덱스
CREATE INDEX idx_system_improvement_requests_status ON EAR.system_improvement_requests(STATUS);
CREATE INDEX idx_system_improvement_requests_created_by ON EAR.system_improvement_requests(CREATED_BY);
CREATE INDEX idx_system_improvement_requests_created_at ON EAR.system_improvement_requests(CREATED_AT);
CREATE INDEX idx_system_improvement_responses_request_id ON EAR.system_improvement_responses(REQUEST_ID);

-- ESM 요청 테이블
CREATE TABLE EAR.esm_requests (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    REQUEST_TITLE NVARCHAR(500) NOT NULL,
    REQUEST_CONTENT NCLOB NOT NULL,
    TEMPLATE_ID INTEGER,
    FORM_DATA NCLOB,
    ATTACHMENTS NCLOB,
    STATUS NVARCHAR(50) DEFAULT 'pending',
    CREATED_BY NVARCHAR(100),
    SALES_CLOUD_CASE_ID NVARCHAR(100),
    SALES_CLOUD_CASE_URL NCLOB,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (TEMPLATE_ID) REFERENCES EAR.ear_request_templates(ID)
);

-- ESM 요청 테이블 인덱스
CREATE INDEX idx_esm_requests_status ON EAR.esm_requests(STATUS);
CREATE INDEX idx_esm_requests_created_at ON EAR.esm_requests(CREATED_AT);
CREATE INDEX idx_esm_requests_sales_cloud_case_id ON EAR.esm_requests(SALES_CLOUD_CASE_ID);

-- IP 화이트리스트 테이블
CREATE TABLE EAR.ip_whitelist (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    IP_ADDRESS NVARCHAR(50) NOT NULL UNIQUE,
    DESCRIPTION NVARCHAR(500),
    IS_ACTIVE BOOLEAN DEFAULT true,
    CREATED_BY NVARCHAR(100),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- IP 화이트리스트 테이블 인덱스
CREATE INDEX idx_ip_whitelist_ip_address ON EAR.ip_whitelist(IP_ADDRESS);
CREATE INDEX idx_ip_whitelist_is_active ON EAR.ip_whitelist(IS_ACTIVE);

-- 메뉴 테이블
CREATE TABLE EAR.menus (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    PARENT_ID INTEGER,
    MENU_CODE NVARCHAR(100) NOT NULL UNIQUE,
    LABEL NVARCHAR(200) NOT NULL,
    PATH NVARCHAR(500),
    ICON_NAME NVARCHAR(100),
    DESCRIPTION NVARCHAR(500),
    DISPLAY_ORDER INTEGER DEFAULT 0,
    IS_ACTIVE BOOLEAN DEFAULT true,
    ADMIN_ONLY BOOLEAN DEFAULT false,
    CREATED_BY NVARCHAR(100),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (PARENT_ID) REFERENCES EAR.menus(ID) ON DELETE CASCADE
);

-- 메뉴 테이블 인덱스
CREATE INDEX idx_menus_parent_id ON EAR.menus(PARENT_ID);
CREATE INDEX idx_menus_menu_code ON EAR.menus(MENU_CODE);
CREATE INDEX idx_menus_is_active ON EAR.menus(IS_ACTIVE);
CREATE INDEX idx_menus_display_order ON EAR.menus(DISPLAY_ORDER);

-- 입력보안 설정 테이블
CREATE TABLE EAR.input_security_settings (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    SETTING_TYPE NVARCHAR(50) NOT NULL, -- 'personal_info', 'profanity'
    SETTING_KEY NVARCHAR(100) NOT NULL, -- 'ssn', 'phone', 'email', 'profanity'
    SETTING_NAME NVARCHAR(200) NOT NULL, -- '주민등록번호', '전화번호', '이메일', '욕설'
    IS_ENABLED BOOLEAN DEFAULT true,
    PATTERN NCLOB, -- 정규식 패턴 (개인정보용)
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(SETTING_TYPE, SETTING_KEY)
);

-- 욕설 패턴 테이블
CREATE TABLE EAR.profanity_patterns (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    PATTERN NVARCHAR(500) NOT NULL,
    DESCRIPTION NVARCHAR(500),
    IS_ACTIVE BOOLEAN DEFAULT true,
    CREATED_BY NVARCHAR(100),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 입력보안 설정 테이블 인덱스
CREATE INDEX idx_input_security_settings_type ON EAR.input_security_settings(SETTING_TYPE);
CREATE INDEX idx_input_security_settings_key ON EAR.input_security_settings(SETTING_KEY);
CREATE INDEX idx_input_security_settings_enabled ON EAR.input_security_settings(IS_ENABLED);
CREATE INDEX idx_profanity_patterns_active ON EAR.profanity_patterns(IS_ACTIVE);

-- 출력보안 패턴 테이블
CREATE TABLE EAR.output_security_patterns (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    PATTERN NVARCHAR(500) NOT NULL,
    DESCRIPTION NVARCHAR(500),
    IS_ACTIVE BOOLEAN DEFAULT true,
    CREATED_BY NVARCHAR(100),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 출력보안 설정 테이블
CREATE TABLE EAR.output_security_settings (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    SETTING_TYPE NVARCHAR(50) NOT NULL DEFAULT 'output_security',
    SETTING_KEY NVARCHAR(100) NOT NULL DEFAULT 'output_security',
    SETTING_NAME NVARCHAR(200) NOT NULL DEFAULT '출력보안',
    IS_ENABLED BOOLEAN DEFAULT false,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(SETTING_TYPE, SETTING_KEY)
);

-- 출력보안 설정 테이블 인덱스
CREATE INDEX idx_output_security_patterns_active ON EAR.output_security_patterns(IS_ACTIVE);
CREATE INDEX idx_output_security_settings_enabled ON EAR.output_security_settings(IS_ENABLED);

-- RAG Agent 관리 테이블
CREATE TABLE EAR.RAG_AGENTS_INFO (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    COMPANY_CODE NVARCHAR(50) NOT NULL,
    AGENT_DESCRIPTION NVARCHAR(500),
    AGENT_URL NVARCHAR(500) NOT NULL,
    AGENT_TOKEN NVARCHAR(500) NOT NULL,
    IS_ACTIVE NVARCHAR(1) DEFAULT 'N',
    CREATED_BY NVARCHAR(100),
    UPDATED_BY NVARCHAR(100),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- RAG Agent 관리 테이블 인덱스
CREATE INDEX idx_rag_agents_info_company_code ON EAR.RAG_AGENTS_INFO(COMPANY_CODE);
CREATE INDEX idx_rag_agents_info_is_active ON EAR.RAG_AGENTS_INFO(IS_ACTIVE);
CREATE INDEX idx_rag_agents_info_company_active ON EAR.RAG_AGENTS_INFO(COMPANY_CODE, IS_ACTIVE);

-- 에이전트 라이프사이클 관리 테이블
CREATE TABLE EAR.agents (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    NAME NVARCHAR(200) NOT NULL,
    DESCRIPTION NCLOB,
    TYPE NVARCHAR(100) NOT NULL,
    STATUS NVARCHAR(50) DEFAULT 'inactive',
    ENV_CONFIG NCLOB,
    MAX_CONCURRENCY INTEGER DEFAULT 1,
    TAGS NCLOB,
    LAST_HEARTBEAT TIMESTAMP,
    IS_ACTIVE BOOLEAN DEFAULT true,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE EAR.agent_roles (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    AGENT_ID INTEGER,
    ROLE_NAME NVARCHAR(100) NOT NULL,
    FOREIGN KEY (AGENT_ID) REFERENCES EAR.agents(ID) ON DELETE CASCADE
);

CREATE TABLE EAR.agent_metrics (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    AGENT_ID INTEGER,
    TIMESTAMP TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CPU_USAGE DECIMAL(5,2),
    MEMORY_USAGE DECIMAL(5,2),
    REQUESTS_PROCESSED INTEGER DEFAULT 0,
    AVG_LATENCY DECIMAL(10,2),
    ERROR_RATE DECIMAL(5,2),
    QUEUE_TIME DECIMAL(10,2),
    FOREIGN KEY (AGENT_ID) REFERENCES EAR.agents(ID) ON DELETE CASCADE
);

CREATE TABLE EAR.agent_tasks (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    AGENT_ID INTEGER,
    JOB_ID NVARCHAR(100),
    STATUS NVARCHAR(50) DEFAULT 'pending',
    RECEIVED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    STARTED_AT TIMESTAMP,
    FINISHED_AT TIMESTAMP,
    RESULT NCLOB,
    FOREIGN KEY (AGENT_ID) REFERENCES EAR.agents(ID) ON DELETE CASCADE
);

CREATE TABLE EAR.job_queue (
    JOB_ID NVARCHAR(100) PRIMARY KEY,
    PAYLOAD NCLOB,
    PRIORITY INTEGER DEFAULT 0,
    STATUS NVARCHAR(50) DEFAULT 'queued',
    ASSIGNED_AGENT_ID INTEGER,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    SCHEDULED_AT TIMESTAMP,
    FOREIGN KEY (ASSIGNED_AGENT_ID) REFERENCES EAR.agents(ID)
);

CREATE TABLE EAR.audit_logs (
    ID INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    USER_ID NVARCHAR(100),
    EVENT_TYPE NVARCHAR(100),
    TARGET_ID NVARCHAR(100),
    TIMESTAMP TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    DETAILS NCLOB
);

-- 에이전트 라이프사이클 관리 테이블 인덱스
CREATE INDEX idx_agents_status ON EAR.agents(STATUS);
CREATE INDEX idx_agents_type ON EAR.agents(TYPE);
CREATE INDEX idx_agents_is_active ON EAR.agents(IS_ACTIVE);
CREATE INDEX idx_agents_last_heartbeat ON EAR.agents(LAST_HEARTBEAT);
CREATE INDEX idx_agent_roles_agent_id ON EAR.agent_roles(AGENT_ID);
CREATE INDEX idx_agent_roles_role_name ON EAR.agent_roles(ROLE_NAME);
CREATE INDEX idx_agent_metrics_agent_id ON EAR.agent_metrics(AGENT_ID);
CREATE INDEX idx_agent_metrics_timestamp ON EAR.agent_metrics(TIMESTAMP);
CREATE INDEX idx_agent_tasks_agent_id ON EAR.agent_tasks(AGENT_ID);
CREATE INDEX idx_agent_tasks_status ON EAR.agent_tasks(STATUS);
CREATE INDEX idx_job_queue_status ON EAR.job_queue(STATUS);
CREATE INDEX idx_job_queue_assigned_agent_id ON EAR.job_queue(ASSIGNED_AGENT_ID);
CREATE INDEX idx_audit_logs_user_id ON EAR.audit_logs(USER_ID);
CREATE INDEX idx_audit_logs_timestamp ON EAR.audit_logs(TIMESTAMP);

-- 기본 관리자 계정 생성 (비밀번호: admin123)
-- HANA는 MERGE 문 사용
MERGE INTO EAR.users AS target
USING (
    SELECT 'admin' AS USERID,
           '$2b$10$3SBkj8urJRAiVRxl9cDk3OlMgCBwpolz8MpoAn6bQkoAzccHgzqy.' AS PASSWORD_HASH,
           '시스템 관리자' AS FULL_NAME,
           true AS IS_ADMIN,
           true AS IS_ACTIVE
    FROM DUMMY
) AS source
ON target.USERID = source.USERID
WHEN MATCHED THEN
    UPDATE SET PASSWORD_HASH = source.PASSWORD_HASH,
               IS_ADMIN = source.IS_ADMIN,
               IS_ACTIVE = source.IS_ACTIVE
WHEN NOT MATCHED THEN
    INSERT (USERID, PASSWORD_HASH, FULL_NAME, IS_ADMIN, IS_ACTIVE)
    VALUES (source.USERID, source.PASSWORD_HASH, source.FULL_NAME, source.IS_ADMIN, source.IS_ACTIVE);
