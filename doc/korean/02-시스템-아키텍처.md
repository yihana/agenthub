# EAR 시스템 아키텍처

## 1. 시스템 아키텍처 개요

EAR 시스템은 3-Tier 아키텍처를 기반으로 하며, SAP BTP Cloud Foundry 환경에서 운영됩니다.

```mermaid
graph TB
    subgraph "Client Layer"
        A[Web Browser]
    end
    
    subgraph "SAP BTP Cloud Foundry"
        subgraph "Application Layer"
            B[React Frontend]
            C[Express Backend]
        end
        
        subgraph "Service Layer"
            D[XSUAA Service]
            E[Object Store]
            F[Destination Service]
            G[Connectivity Service]
        end
        
        subgraph "Data Layer"
            H[SAP HANA Database]
        end
    end
    
    subgraph "External Services"
        I[OpenAI API]
        J[SAP IAS]
        K[SK Networks RAG]
        L[C4C System]
    end
    
    A -->|HTTPS| B
    B -->|REST API| C
    C -->|Authentication| D
    C -->|File Storage| E
    C -->|Database| H
    C -->|External API| I
    C -->|External API| K
    C -->|External API| L
    D -->|OAuth2| J
    C -->|Service Binding| F
    C -->|Service Binding| G
```

## 2. 컴포넌트 아키텍처

### 2.1 Frontend 아키텍처

```mermaid
graph LR
    subgraph "React Application"
        A[App.tsx<br/>Main Router]
        B[Pages<br/>Page Components]
        C[Components<br/>Reusable Components]
        D[Hooks<br/>Custom Hooks]
        E[Utils<br/>Utilities]
    end
    
    A --> B
    B --> C
    C --> D
    C --> E
    E -->|API Calls| F[Backend API]
```

#### 주요 컴포넌트

- **Pages**: 각 화면별 페이지 컴포넌트
  - LoginPage, EARRequestRegistration, RAGDocumentManagement 등
- **Components**: 재사용 가능한 UI 컴포넌트
  - ChatPane, HistoryPane, MenuPane 등
- **Hooks**: 커스텀 React Hooks
  - useAuth, useFirewallIntent, useMenus
- **Utils**: 유틸리티 함수
  - api.ts (API 호출), htmlSanitizer.ts (XSS 방지)

### 2.2 Backend 아키텍처

```mermaid
graph TB
    subgraph "Express Server"
        A[index.ts<br/>Server Entry]
        B[Routes<br/>API Endpoints]
        C[Middleware<br/>Auth, IP Whitelist]
        D[Utils<br/>Helpers]
        E[RAG Engine]
    end
    
    subgraph "Database Layer"
        F[db.ts<br/>Database Abstraction]
        G[db-hana.ts]
        H[db-postgres.ts]
    end
    
    A --> B
    B --> C
    B --> D
    B --> E
    B --> F
    F --> G
    F --> H
    G --> I[(HANA DB)]
    H --> J[(PostgreSQL)]
```

#### 주요 모듈

- **Routes**: API 엔드포인트 정의
  - `/api/chat`, `/api/ear`, `/api/rag`, `/api/auth` 등
- **Middleware**: 요청 처리 미들웨어
  - `auth.ts`: JWT/XSUAA 인증
  - `ipWhitelist.ts`: IP 화이트리스트 검증
- **RAG Engine**: RAG 파이프라인 처리
  - 문서 임베딩, 벡터 검색, LLM 응답 생성

## 3. 데이터 흐름

### 3.1 채팅 요청 처리 흐름

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant B as Backend
    participant R as RAG Engine
    participant DB as Database
    participant O as OpenAI API
    
    U->>F: 채팅 메시지 입력
    F->>B: POST /api/chat
    B->>B: 인증 검증
    B->>R: 의도 감지
    R->>DB: 벡터 검색
    DB-->>R: 유사 문서 반환
    R->>O: LLM 요청 (컨텍스트 포함)
    O-->>R: 응답 생성
    R-->>B: 응답 반환
    B->>DB: 채팅 히스토리 저장
    B-->>F: 스트리밍 응답
    F-->>U: 실시간 답변 표시
```

### 3.2 요청 등록 처리 흐름

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant B as Backend
    participant DB as Database
    participant C as C4C/ESM
    
    U->>F: EAR 요청 등록
    F->>B: POST /api/ear/requests
    B->>B: 입력 검증 및 보안 필터링
    B->>DB: 요청 저장
    DB-->>B: 저장 완료
    B->>C: 외부 시스템 연동 (선택)
    C-->>B: 연동 결과
    B-->>F: 요청 ID 반환
    F-->>U: 등록 완료 표시
```

### 3.3 인증 및 권한 처리 흐름

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant B as Backend
    participant X as XSUAA
    participant I as SAP IAS
    
    U->>F: 로그인 요청
    F->>B: POST /api/auth/login
    B->>X: 토큰 검증 요청
    X->>I: 사용자 인증 확인
    I-->>X: 인증 결과
    X-->>B: JWT 토큰 발급
    B->>B: 권한 확인
    B-->>F: 토큰 및 사용자 정보
    F->>F: localStorage에 토큰 저장
    F-->>U: 로그인 완료
```

## 4. 보안 아키텍처

```mermaid
graph TB
    subgraph "Security Layers"
        A[Network Security<br/>IP Whitelist]
        B[Authentication<br/>XSUAA/IAS]
        C[Authorization<br/>Role-based]
        D[Input Security<br/>XSS/SQL Injection]
        E[Output Security<br/>Data Filtering]
    end
    
    A --> B
    B --> C
    C --> D
    D --> E
```

### 보안 계층

1. **네트워크 보안**: IP 화이트리스트를 통한 접근 제어
2. **인증**: SAP IAS를 통한 사용자 인증
3. **권한 관리**: XSUAA를 통한 역할 기반 접근 제어
4. **입력 보안**: XSS, SQL Injection 등 공격 방지
5. **출력 보안**: 민감 정보 필터링 및 마스킹

## 5. 배포 아키텍처

```mermaid
graph TB
    subgraph "SAP BTP Cloud Foundry"
        A[EAR Application<br/>2 Instances]
        B[EAR-PRD Service<br/>HANA Database]
        C[ear-xsuaa Service]
        D[Object Store Service]
        E[Destination Service]
        F[Connectivity Service]
        G[Private Link Service]
    end
    
    subgraph "External"
        H[OpenAI API]
        I[SAP IAS]
        J[SK Networks RAG]
    end
    
    A --> B
    A --> C
    A --> D
    A --> E
    A --> F
    A --> G
    C --> I
    A --> H
    A --> J
```

### 배포 구성

- **애플리케이션**: 2개 인스턴스 (고가용성)
- **메모리**: 2GB per instance
- **디스크**: 2GB per instance
- **Health Check**: HTTP endpoint (`/health`)

## 6. 데이터베이스 아키텍처

```mermaid
erDiagram
    USERS ||--o{ CHAT_HISTORY : has
    USERS ||--o{ EAR_REQUESTS : creates
    USERS ||--o{ LOGIN_HISTORY : has
    RAG_DOCUMENTS ||--o{ RAG_CHUNKS : contains
    EAR_KEYWORDS ||--o{ EAR_REQUEST_TEMPLATES : has
    EAR_REQUEST_TEMPLATES ||--o{ EAR_REQUESTS : uses
    CHAT_HISTORY ||--o{ IMPROVEMENT_REQUESTS : references
    COMPANY_INTERFACES ||--o{ INTERFACE_HISTORY : has
```

### 주요 테이블 그룹

1. **사용자 관리**: users, login_history
2. **채팅 시스템**: chat_history, chat_intent_patterns
3. **RAG 시스템**: rag_documents, rag_chunks, rag_agents_info
4. **요청 관리**: ear_requests, ear_keywords, ear_request_templates
5. **시스템 관리**: menus, group_menu_mappings, ip_whitelist

## 7. 통합 아키텍처

### 7.1 외부 시스템 연동

```mermaid
graph LR
    A[EAR System] -->|REST API| B[C4C System]
    A -->|REST API| C[SK Networks RAG]
    A -->|REST API| D[OpenAI API]
    A -->|OAuth2| E[SAP IAS]
    A -->|Service Binding| F[SAP HANA]
    A -->|S3 API| G[Object Store]
```

### 7.2 인터페이스 자동화

- **회사별 API 연동**: 동적 필드 매핑을 통한 외부 API 연동
- **인증 방식 지원**: Bearer Token, Basic Auth 등
- **변경 이력 관리**: 모든 인터페이스 변경사항 추적

## 8. 확장성 고려사항

### 8.1 수평 확장

- Cloud Foundry의 자동 스케일링 기능 활용
- 로드 밸런싱을 통한 트래픽 분산
- 상태 비저장(Stateless) 아키텍처 설계

### 8.2 성능 최적화

- 데이터베이스 인덱스 최적화
- 벡터 검색 성능 튜닝
- 캐싱 전략 (향후 Redis 도입 가능)

### 8.3 모니터링

- Health Check 엔드포인트 제공
- 로그 수집 및 분석
- 에러 추적 및 알림


